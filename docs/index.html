<script>
  const GROUPS = [
    { id: "ofac", title: "OFAC – Sanctions & AML", keys: ["OFAC"] },
    { id: "irs", title: "IRS – Tax Administration", keys: ["IRS"] },
    { id: "payments", title: "Payments – Nacha & Federal Reserve", keys: ["Payments"] },
    { id: "banking", title: "Federal Banking Agencies – OCC, FDIC, FRB", keys: ["Banking"] },
    { id: "mortgage", title: "Mortgage – MPF, Fannie Mae, Freddie Mac", keys: ["Mortgage"] },
    { id: "usda", title: "USDA – Rural Development (Housing)", keys: ["USDA"] },
    { id: "exec", title: "Legislative & Executive – Senate, White House, Federal Register", keys: ["Legislative"] },
    { id: "infosec", title: "Information Security", keys: ["Information Security"] },
    { id: "fintech", title: "Fintech Watch", keys: ["Fintech Watch"] },

    // ✅ FIX: build.py outputs "Payment Card Network" (singular)
    // Keep both to be future-proof.
    { id: "cardnet", title: "Payment Card Networks", keys: ["Payment Card Network", "Payment Card Networks"] },
  ];

  function fmtDate(iso) {
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
  }

  function itemKey(i) {
    const k = (i && (i.category || i.source)) ? (i.category || i.source) : "";
    return String(k || "").trim();
  }

  function renderSection(group, items, content) {
    const section = document.createElement("section");
    section.id = group.id;

    const h2 = document.createElement("h2");
    h2.textContent = group.title;
    section.appendChild(h2);

    const groupItems = (items || [])
      .filter(i => group.keys.includes(itemKey(i)))
      .sort((a, b) => new Date(b.published_at) - new Date(a.published_at));

    if (!groupItems.length) {
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent = "No items in the current rolling window.";
      section.appendChild(empty);
    } else {
      const ul = document.createElement("ul");
      ul.className = "items";

      groupItems.forEach(i => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="headline">
            <span class="source">[${i.source}]</span>
            <a href="${i.url}" target="_blank" rel="noopener">${i.title}</a>
            <span class="date">${fmtDate(i.published_at)}</span>
          </div>
          ${i.summary ? `<div class="summary">${i.summary}</div>` : ""}
        `;
        ul.appendChild(li);
      });

      section.appendChild(ul);
    }

    content.appendChild(section);
  }

  function dataUrl() {
    // ✅ simplest + reliable for GitHub Pages project sites
    return `data/items.json?v=${Date.now()}`;
  }

  (async () => {
    const content = document.getElementById("content");
    const loading = document.getElementById("loading");

    try {
      const url = dataUrl();
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status} loading ${url}`);
      const data = await r.json();

      document.getElementById("window").textContent =
        `Rolling window: ${fmtDate(data.window_start)} → ${fmtDate(data.window_end)} (UTC)`;

      document.getElementById("count").textContent =
        `Total items loaded: ${(data.items || []).length}`;

      const last = document.getElementById("last-updated");
      if (last) {
        const ct = data.generated_at_ct || "";
        const utc = data.generated_at_utc || "";
        last.textContent = ct
          ? `Last updated: ${ct} (CT)${utc ? " — " + utc + " (UTC)" : ""}`
          : (utc ? `Last updated: ${utc} (UTC)` : "");
      }

      content.innerHTML = "";
      GROUPS.forEach(g => renderSection(g, data.items || [], content));
      if (loading) loading.remove();
    } catch (e) {
      if (loading) loading.remove();
      console.error(e);

      content.innerHTML = `
        <div class="empty" style="border:1px solid #f2c; padding:12px; border-radius:10px;">
          <p><strong>Could not load dashboard data.</strong></p>
          <p style="margin:6px 0 12px 0;">${String(e)}</p>
          <p style="margin:0;">
            Try:
            <a href="raw/" target="_blank" rel="noopener">Static Export</a> ·
            <a href="raw/index.html" target="_blank" rel="noopener">raw/index.html</a> ·
            <a href="print/items.html" target="_blank" rel="noopener">print/items.html</a>
          </p>
        </div>
      `;
    }
  })();
</script>
