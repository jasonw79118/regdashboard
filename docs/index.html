<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RegDashboard – Regulatory Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
  <header>
    <h1>RegDashboard</h1>
    <div class="subtitle">Rolling Regulatory Intelligence</div>
    <div id="window" class="window"></div>
    <div id="count" class="window"></div>

    <div id="debug-counts" class="window" style="font-size:0.9em; opacity:.85;"></div>

    <div class="window" style="font-size: 0.95em;">
      Copilot-friendly exports:
      <a href="raw/" target="_blank" rel="noopener">Static Export</a>
      · <a href="raw/items.md" target="_blank" rel="noopener">items.md</a>
      · <a href="raw/items.txt" target="_blank" rel="noopener">items.txt</a>
      · <a href="raw/items.ndjson" target="_blank" rel="noopener">items.ndjson</a>
      · <a href="print/items.html" target="_blank" rel="noopener">print/items.html</a>
    </div>

    <div class="window" style="font-size: 0.95em;">
      <a
        href="https://github.com/jasonw79118/regdashboard/actions/workflows/regdashboard-build.yml"
        target="_blank"
        rel="noopener"
        class="btn"
        style="display:inline-block;padding:8px 12px;border:1px solid #ddd;border-radius:10px;text-decoration:none;"
      >
        Force update (Run workflow)
      </a>
      <span style="margin-left:10px;color:#555;">
        Opens GitHub Actions — click <strong>Run workflow</strong> to rebuild now.
      </span>
    </div>

    <nav class="nav">
      <a href="#ofac">OFAC</a>
      <a href="#irs">IRS</a>
      <a href="#payments">Payments</a>
      <a href="#banking">Banking</a>
      <a href="#mortgage">Mortgage</a>
      <a href="#usda">USDA</a>
      <a href="#exec">Legislative & Executive</a>
      <a href="#infosec">Information Security</a>
      <a href="#fintech">Fintech Watch</a>
      <a href="#cardnet">Payment Card Networks</a>
      <a href="raw/" target="_blank" rel="noopener">Static Export (Copilot)</a>
    </nav>
  </header>

  <main id="content">
    <p id="loading">Loading items…</p>
  </main>

  <footer>
    <hr />
    <p class="disclaimer">
      RegDashboard provides links and original summaries of publicly available regulatory and governmental information.
      Content remains the property of the originating agency or publisher. This site does not reproduce publications in full.
    </p>
    <p id="last-updated" style="margin:18px 0;text-align:center;font-size:12px;opacity:.75;"></p>
  </footer>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const GROUPS = [
      { id: "ofac",     title: "OFAC – Sanctions & AML", keys: ["OFAC"] },
      { id: "irs",      title: "IRS – Tax Administration", keys: ["IRS"] },
      { id: "payments", title: "Payments – Nacha & Federal Reserve", keys: ["Payments"] },
      { id: "banking",  title: "Federal Banking Agencies – OCC, FDIC, FRB", keys: ["Banking"] },
      { id: "mortgage", title: "Mortgage – MPF, Fannie Mae, Freddie Mac", keys: ["Mortgage"] },

      // USDA can arrive as "USDA" or "USDA Rural Development" depending on build.py mapping
      { id: "usda",     title: "USDA – Rural Development (Housing)", keys: ["USDA", "USDA Rural Development"] },

      { id: "exec",     title: "Legislative & Executive – Senate, White House, Federal Register", keys: ["Legislative"] },

      // IS vs Information Security (we normalize both directions)
      { id: "infosec",  title: "Information Security", keys: ["IS", "Information Security"] },

      // Sometimes this ends up as "Fintech" depending on earlier scripts
      { id: "fintech",  title: "Fintech Watch", keys: ["Fintech Watch", "Fintech"] },

      // Card networks have lots of name variants; normalize them all
      { id: "cardnet",  title: "Payment Card Networks", keys: [
        "Payment Card Network",
        "Payment Card Networks",
        "Card Network",
        "Card Networks",
        "Visa",
        "Mastercard"
      ]},
    ];

    function $(id) { return document.getElementById(id); }

    function fmtDate(iso) {
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
    }

    function normalizeKey(k) {
      const s = String(k || "").trim();
      if (!s) return "";
      const lower = s.toLowerCase();

      // Information security variants
      if (lower === "infosec" || lower === "info sec" || lower === "information security") return "IS";
      if (lower === "is") return "IS";

      // Fintech variants
      if (lower === "fintech watch" || lower === "fintech") return "Fintech Watch";

      // USDA variants
      if (lower === "usda rural development") return "USDA";
      if (lower === "usda") return "USDA";

      // Card network variants
      if (lower === "payment card networks" || lower === "payment card network" || lower === "card networks" || lower === "card network") return "Payment Card Network";
      if (lower === "visa" || lower === "mastercard") return "Payment Card Network";

      return s;
    }

    function itemKey(i) {
      if (!i) return "";
      return normalizeKey(i.category || i.source || "");
    }

    function renderSection(group, items, content) {
      const section = document.createElement("section");
      section.id = group.id;

      const h2 = document.createElement("h2");
      h2.textContent = group.title;
      section.appendChild(h2);

      const groupKeys = (group.keys || []).map(normalizeKey);
      const groupItems = (items || [])
        .filter(i => groupKeys.includes(itemKey(i)))
        .sort((a, b) => new Date(b.published_at) - new Date(a.published_at));

      if (!groupItems.length) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "No items in the current rolling window.";
        section.appendChild(empty);
      } else {
        const ul = document.createElement("ul");
        ul.className = "items";

        groupItems.forEach(i => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div class="headline">
              <span class="source">[${i.source}]</span>
              <a href="${i.url}" target="_blank" rel="noopener">${i.title}</a>
              <span class="date">${fmtDate(i.published_at)}</span>
            </div>
            ${i.summary ? `<div class="summary">${i.summary}</div>` : ""}
          `;
          ul.appendChild(li);
        });

        section.appendChild(ul);
      }

      content.appendChild(section);
    }

    // Make sure relative fetch works even if someone visits without trailing slash
    function dataUrl() {
      const here = new URL(window.location.href);
      // force base to "directory" form
      const dir = here.href.endsWith("/") ? here.href : (here.href + "/");
      const u = new URL("data/items.json", dir);
      u.searchParams.set("v", String(Date.now()));
      return u.toString();
    }

    function renderDebugCounts(items) {
      const el = $("debug-counts");
      if (!el) return;
      const counts = {};
      (items || []).forEach(it => {
        const k = String(it.category || it.source || "").trim();
        counts[k] = (counts[k] || 0) + 1;
      });
      const keys = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
      el.textContent = keys.length
        ? ("Loaded categories: " + keys.map(k => `${k}=${counts[k]}`).join(" · "))
        : "Loaded categories: (none)";
    }

    (async () => {
      const content = $("content");
      if (!content) return;

      const loading = $("loading");

      try {
        const url = dataUrl();
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error(`HTTP ${r.status} loading ${url}`);
        const data = await r.json();

        const w = $("window");
        if (w) w.textContent = `Rolling window: ${fmtDate(data.window_start)} → ${fmtDate(data.window_end)} (UTC)`;

        const c = $("count");
        if (c) c.textContent = `Total items loaded: ${(data.items || []).length}`;

        const last = $("last-updated");
        if (last) {
          const ct = data.generated_at_ct || "";
          const utc = data.generated_at_utc || "";
          last.textContent = ct
            ? `Last updated: ${ct} (CT)${utc ? " — " + utc + " (UTC)" : ""}`
            : (utc ? `Last updated: ${utc} (UTC)` : "");
        }

        renderDebugCounts(data.items || []);

        if (loading) loading.remove();
        content.innerHTML = "";
        GROUPS.forEach(g => renderSection(g, data.items || [], content));
      } catch (e) {
        if (loading) loading.remove();
        console.error(e);

        content.innerHTML = `
          <div class="empty" style="border:1px solid #f2c; padding:12px; border-radius:10px;">
            <p><strong>Could not load dashboard data.</strong></p>
            <p style="margin:6px 0 12px 0;">${String(e)}</p>
            <p style="margin:0;">
              Try:
              <a href="raw/" target="_blank" rel="noopener">Static Export</a> ·
              <a href="raw/index.html" target="_blank" rel="noopener">raw/index.html</a> ·
              <a href="print/items.html" target="_blank" rel="noopener">print/items.html</a>
            </p>
          </div>
        `;
      }
    })();
  });
</script>
</body>
</html>
